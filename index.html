<!DOCTYPE html>
<html lang="en">
    <head>
        <title>MSDN</title>
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font: 13px Helvetica, Arial; }
            button { cursor: pointer; }
            form#begin { height: 100%; position: absolute; width: 100%; background-color: darkgrey; z-index: 1; }
            form#begin div { position: absolute; top: calc(50% - 83px); left: calc(50% - 150px); width: 300px; text-align: center; }
            form#begin input { outline: 0; background-color: darkgrey; width: 300px; font-size: 50px; border: 0; border-bottom: 3px solid white; }
            form#begin button { font-size: 30px; width: 250px; margin-top: 10px; background-color: grey; border: 2px solid white; color: white; padding: 5px; border-radius: 10px; }
            
            #controls { background: darkgrey; padding: 3px; position: fixed; bottom: 2px; width: 100%; }
            #controls > div { display: inline-block; }
            #controls > div > button { height: 30px; width: 30px; }
            form#chat { display: inline-block; width: calc(100% - 70px); }
            form#chat input { height: 30px; padding: 5px; width: calc(100% - 55px); }
            form#chat button { height: 30px; width: 50px; }
            
            #flyouts { position: fixed; bottom: 38px; width: 100%; height: 170px; margin-bottom: -2px; }
            #flyouts > div { display: none; }
            #fo-users { height: 170px; width: 200px; overflow: auto; border: 2px solid #aaaaaa; border-top-right-radius: 10px; padding: 5px; background-color: white; }
            #connUsers { border-bottom: 2px solid #aaaaaa; margin-left: -5px; padding-left: 5px; width: 75%; margin-bottom: 5px; }
            #you > p { display: inline; }
            #fo-options { border: 2px solid #aaaaaa; border-top-right-radius: 10px; padding: 5px; height: 170px; background-color: white; position: relative; }
            #fo-options span { display: block; }
            #fo-options label { width: 20px; }
            #change-colour > label { display: block; margin-top: 10px; width: 100%; }
            #fo-options span:last-child { display: block; width: 100%; text-align: center; margin-top: 10px; }
            .both-options { bottom: 13px; margin-left: -6px; }
            .both-users { border-top-right-radius: 0 !important; }
            
            #messages { position: absolute; height: calc(100% - 40px); width: 100%; overflow: auto;}
            #messages dt,dd { display: inline-block; }
            #messages dt { width: 100px; }
            #messages dd { width: calc(100% - 100px); }
            #messages span { display: block; padding-left: 5px; }
            #messages span:nth-child(odd) { background-color: #f2f2f2; }
            #messages .sys { text-align: center; font-size: 15px; font-weight: bold; padding: 5px; }
            .set-colour[name=initial] { margin-top: 10px; }
            .set-colour { overflow: hidden; height: 37px; outline: 0; }
            .set-colour option { height: 35px; width: 30px; display: inline-block; cursor: pointer; }
            option[value=black]{background-color:black;}
            option[value=green]{background-color:green;}
            option[value=blue]{background-color:blue;}
            option[value=yellow]{background-color:yellow}
            option[value=red]{background-color:red}
        </style>
    </head>
    <body>
        <form id="begin" action="">
            <div>
                <input id="nickname" maxlength="16" placeholder="Nickname" autofocus />
                <select class="set-colour" name="initial" size="5">
                    <option value="black"></option>
                    <option value="green"></option>
                    <option value="blue"></option>
                    <option value="yellow"></option>
                    <option value="red"></option>
                </select>
                <button>Set Nickname</button>
            </div>
        </form>
        <dl id="messages"></dl>
        <div id="flyouts">
            <div id="fo-users">
                <p></p>
            </div>
            <div id="fo-options">
                <form id="options" action="">
                    <span>
                        <input type="checkbox" value="bold">
                        <label for="bold">Bold</label>
                    </span>
                    <span>
                        <input type="checkbox" value="italic">
                        <label for="italic">Italic</label>
                    </span>
                    <span>
                        <input type="checkbox" value="strikethrough">
                        <label for="strikethrough">Strikethrough</label>
                    </span>
                    <span>
                        <input type="checkbox" value="marquee">
                        <label for="marquee">Marquee</label>
                    </span>
                    <span id="change-colour">
                        <label for="change">Nickname Colour</label>
                        <select class="set-colour" name="change" size="5">
                            <option value="black"></option>
                            <option value="green"></option>
                            <option value="blue"></option>
                            <option value="yellow"></option>
                            <option value="red"></option>
                        </select>
                    </span>
                    <span>
                        <button>
                            <i class="fa fa-check"></i>
                        </button>
                    </span>
                </form>
            </div>
        </div>
        <div id="controls">
            <div>
                <button onclick="toggleFlyouts('users')">
                    <i class="fa fa-user-circle"></i>
                </button>
                <button onclick="toggleFlyouts('options')">
                    <i class="fa fa-tint"></i>
                </button>
            </div>
            <form id="chat" action="">
                <input id="m" autocomplete="off" />
                <button>Send</button>
            </form>
        </div>
        
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var user = {nickname: "", id: "", flair: {colour: "black", styles: "", marquee: false}};
            var socket = io();
            $("form#begin").submit(function(){
                if($("#nickname").val() != ""){
                    if($(".set-colour[name=initial]").val() == null
                    || $(".set-colour[name=initial]").val() == "")
                        user.flair.colour = "black";
                    else
                        user.flair.colour = $(".set-colour[name=initial]").val();
                    user.nickname = $("#nickname").val();
                    user.id = socket.id;
                    socket.emit("user joined", user);
                    $("form#begin").hide();
                    $("#m").focus();
                }
                return false;
            });
            $("form#chat").submit(function(){
                if($("#m").val() != ""){
                    var chat = {user: user, message: $("#m").val()};
                    socket.emit("chat message", chat);
                    $("#m").val("");
                }
                return false;
            });
            $("form#options").submit(function(){
                var colour = $(".set-colour[name=change]").val();
                user.flair.colour = colour;
                user.flair.styles = styleBuilder();
                if($("input[value=marquee]").is(":checked"))
                    user.flair.marquee = true;
                else
                    user.flair.marquee = false;
                
                socket.emit("save options", user);
                return false;
            });
            function toggleFlyouts(elem){
                if(!($("#fo-" + elem).is(":visible")))
                    $("#fo-" + elem).css("display", "inline-block");
                else
                    $("#fo-" + elem).removeAttr("style");
                
                if($("#fo-users").is(":visible")){
                    socket.emit("get users");
                }
                
                if($("#fo-users").is(":visible") && $("#fo-options").is(":visible")){
                    $("#fo-users").addClass("both-users");
                    $("#fo-options").addClass("both-options");
                }
                else
                    $("#fo-users, #fo-options").removeAttr("class");
            }
            function styleBuilder(){
                var style = "";
                
                if($("input[value=bold]").is(":checked"))
                    style = "font-weight:bold;";
                if($("input[value=italic]").is(":checked"))
                    style += "font-style:italic;";
                if($("input[value=strikethrough]").is(":checked"))
                    style += "text-decoration:line-through;";
                
                return style;
            }
            function nicknameBuilder(curUser){
                var styling = "";
                
                styling += "<p style='color:" + curUser.flair.colour + ";";
                styling += curUser.flair.styles + "'>";
                if(curUser.flair.marquee)
                    styling += "<marquee>" + curUser.nickname + "</marquee></p>";
                else
                    styling += curUser.nickname + "</p>";
                
                return styling;
            }
            socket.on("user event", function(user){
                var message = "<span class='sys'>" + user + ".</span>";
                $("#messages").append(message);
                $("#messages").scrollTop($("#messages")[0].scrollHeight);
            });
            socket.on("chat message", function(chat){
                chat.message = chat.message.replace(/</g, "&lt;");
                chat.message = chat.message.replace(/>/g, "&gt;");
                
                var message = "<span><dt>" + nicknameBuilder(chat.user) + "</dt>";
                message += "<dd>" + chat.message + "</dd></span>";
                
                $("#messages").append(message);
                $("#messages").scrollTop($("#messages")[0].scrollHeight);
            });
            socket.on("list users", function(users){
                $("#fo-users").html("<p id='connUsers'>Connected Users: " + users.length + "</p>");
                var name = "<div id='you'>" + nicknameBuilder(user) + ", that's you!</div>";
                $("#fo-users").append(name);
                
                for(var i=0; i<users.length; i++){
                    if(users[i].nickname != user.nickname)
                        $("#fo-users").append(nicknameBuilder(users[i]));
                }
            });
        </script>
    </body>
</html>
